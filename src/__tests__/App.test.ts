// @ts-nocheck
import chalk from 'chalk'
import { screen, prettyDOM, act } from '@testing-library/react'
import { Root } from 'react-dom/client'

function withMessage(cb, message, { solo = true } = {}) {
	try {
		cb()
	} catch (error) {
		if (solo) {
			// eslint-disable-next-line no-throw-literal
			throw `ðŸš¨  ${chalk.reset.red(message)}`
		} else {
			error.message = `ðŸš¨  ${chalk.reset.red(message)}\n\n${error.message}`
		}
		throw error
	}
}

test('renders the app', () => {
	const root = document.createElement('div')
	root.id = 'root'
	document.body.append(root)

	let reactRoot: Root
	act(() => {
		reactRoot = require('..').root
	})

	screen.getByTitle('Bookshelf')
	screen.getByRole('heading', { name: /Bookshelf/i })
	screen.getByRole('button', { name: /Login/i })
	screen.getByRole('button', { name: /Register/i })

	const cssEl = document.body.querySelector('[css]')
	withMessage(
		() => expect(cssEl).toBeNull(),
		`
At least one element has an attribute called "css". This means that emotion did not compile the prop correctly.

Make sure to include this at the top of the file:

/** @jsx jsx */
import {jsx} from '@emotion/core'


Here's the element that has the css attribute that wasn't compiled:

${prettyDOM(cssEl)}
    `.trim(),
	)

	withMessage(
		() => expect(document.body.querySelector('[class*=css-]')).not.toBeNull(),
		`None of the elements are styled by emotion. Make sure to render a styled component and use the css prop.`,
	)

	// cleanup
	act(() => reactRoot.unmount())
	document.body.removeChild(root)
})
